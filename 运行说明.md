# ModelScope API WebUI 运行说明

本项目提供了Windows和Linux两个平台的自动化启动脚本，可以自动激活虚拟环境并运行程序。

## 🆕 最新更新

### 元数据与参数管理功能 (v2.1)
- **📊 元数据嵌入**：文生图和图像编辑模块支持生成参数嵌入到图像EXIF中
- **💾 参数管理**：支持保存生成参数为JSON文件，支持从图像/文件加载参数
- **🔄 参数复用**：可重复使用保存的参数进行批量处理
- **🎨 界面优化**：参数管理控件重新布局，界面更加平衡美观

### 模块化重构 (v2.0)
- **🏗️ 全新架构**：采用模块化设计，代码结构更清晰
- **🖼️ 新增功能**：集成 Photopea 在线图像编辑器
- **📦 模块分离**：将功能拆分为独立模块，便于维护和扩展
- **🔧 易于开发**：主文件从近1000行缩减到约400行

### 功能模块
- **文生图模块** (`modules/text_to_image.py`) - **新增元数据功能**
- **图像编辑模块** (`modules/image_edit.py`) - **新增参数管理功能**
- **文本对话模块** (`modules/text_chat.py`)
- **图生文模块** (`modules/image_to_text.py`)
- **Photopea编辑器模块** (`modules/photopea.py`)
- **手绘白板模块** (`modules/whiteboard.py`)
- **公共工具模块** (`modules/common.py`) - **增强元数据工具**

## Windows 用户

本项目提供了两个Windows批处理文件：

### 1. run_windows.bat（完整版）
**推荐首次使用**

#### 使用方法
双击运行 `run_windows.bat` 文件，或在命令提示符中执行：
```cmd
run_windows.bat
```

#### 脚本功能
- 自动检查并创建虚拟环境（如果不存在）
- 激活虚拟环境
- 安装项目依赖（requirements.txt）
- 后台启动 gradio_app.py 应用程序
- 等待8秒确保应用完全启动
- 自动打开浏览器并使用深色主题
- 显示中英文对照的操作提示
- 按任意键可安全退出应用

### 2. run_windows_existvenv.bat（快速版）
**适用于已有虚拟环境的情况**

#### 使用方法
双击运行 `run_windows_existvenv.bat` 文件，或在命令提示符中执行：
```cmd
run_windows_existvenv.bat
```

#### 脚本功能
- 直接激活现有虚拟环境
- 后台启动 gradio_app.py 应用程序
- 等待8秒确保应用完全启动
- 自动打开浏览器并使用深色主题
- 显示中英文对照的操作提示
- 按任意键可安全退出应用
- **注意**：此脚本假设虚拟环境已存在，不会创建新环境或安装依赖

## Linux/macOS 用户

### 首次使用
需要先设置脚本的可执行权限：
```bash
chmod +x run_linux.sh
```

### 使用方法
在终端中执行：
```bash
./run_linux.sh
```

### 脚本功能
- 自动检查并创建虚拟环境（如果不存在）
- 激活虚拟环境
- 安装项目依赖（requirements.txt）
- 后台启动 gradio_app.py 应用程序
- 等待8秒确保应用完全启动
- 自动打开浏览器并使用深色主题
- 显示中英文对照的操作提示
- 按 Ctrl+C 可安全退出应用

## 脚本选择建议

### Windows用户
- **首次使用**：选择 `run_windows.bat`，它会自动处理所有设置
- **日常使用**：如果虚拟环境已创建且依赖已安装，可使用 `run_windows_existvenv.bat` 快速启动
- **重新安装依赖**：使用 `run_windows.bat`

### Linux用户
- 使用 `run_linux.sh`，功能完整且自动化程度高

### 🌐 访问地址
所有脚本启动后，应用将在以下地址运行：
- **本地访问**: http://127.0.0.1:7860
- **自动打开**: 脚本会等待8秒后自动打开默认浏览器
- **深色主题**: 默认使用深色主题，提供更好的视觉体验

### 🎨 主题选项
- **深色主题**: http://127.0.0.1:7860/?__theme=dark （脚本默认）
- **浅色主题**: http://127.0.0.1:7860/?__theme=light
- **系统主题**: http://127.0.0.1:7860 （跟随系统设置）

### 🚀 启动流程
1. **双击运行脚本**
2. **查看中英文对照的启动信息**
3. **等待应用启动（约8秒）**
4. **浏览器自动打开深色主题界面**
5. **开始使用应用**
6. **按指定键安全退出**

### 🎯 功能标签页
启动后，您将看到以下6个功能标签页：

1. **📝 文生图**：输入文本描述生成AI图像
2. **✏️ 图像编辑**：上传图片进行AI驱动的编辑
3. **💬 文本对话**：与AI模型进行多轮对话
4. **🔍 图生文**：上传图片获取AI描述和分析
5. **✍️ 手绘白板**：专业手绘白板工具，支持 Excalidraw 和 tldraw
6. **🖼️ Photopea**：专业级在线图像编辑器（类似Photoshop）

#### 元数据与参数管理特色
- **📊 完整参数记录**：生成的图像自动包含除API token外的所有生成参数
- **💾 参数保存**：支持将当前参数保存为JSON文件，自动命名（t2i_日期时间.json）
- **🔄 参数加载**：支持从包含元数据的图像或JSON文件加载参数
- **🎯 精确控制**：可选择是否启用元数据嵌入功能
- **🔒 安全存储**：参数文件不包含敏感信息（API token）

#### 手绘白板特色
- **🎨 双工具集成**：
  - **Excalidraw**：简洁手绘风格，适合快速草图和流程图
  - **tldraw**：现代化界面，功能丰富，支持多种绘图模式
- **🔄 状态保持**：两个白板工具独立运行，切换时保持各自编辑状态
- **📝 多功能支持**：
  - 手绘图形、文本标注
  - 流程图、思维导图
  - 原型设计、头脑风暴
- **💾 导出功能**：支持导出为 PNG、SVG 等格式
- **🌐 实时协作**：支持多人实时协作编辑（需相应服务支持）

#### Photopea 编辑器特色
- **🎨 专业功能**：支持图层、滤镜、画笔等专业工具
- **📁 格式支持**：支持 PSD、XCF、Sketch 等多种格式
- **🌐 在线使用**：无需安装，直接在浏览器中使用
- **🆓 完全免费**：功能媲美 Photoshop，完全免费
- **📱 拖拽支持**：可直接拖拽图片到编辑器中

## 注意事项

1. **Python环境要求**：
   - Windows: 确保系统已安装Python 3.7+
   - Linux/macOS: 确保系统已安装python3

2. **网络连接**：首次运行时需要网络连接来下载依赖包

3. **权限问题**：
   - Windows: 如果遇到权限问题，请以管理员身份运行
   - Linux: 确保对项目目录有读写权限

4. **虚拟环境**：脚本会自动在项目根目录创建 `.venv` 虚拟环境

5. **脚本选择**：
   - `run_windows.bat`: 完整功能，适合首次使用
   - `run_windows_existvenv.bat`: 快速启动，适合日常使用
   - `run_linux.sh`: Linux/macOS完整功能脚本

## 手动运行方式

如果自动脚本遇到问题，也可以手动执行以下步骤：

### Windows
```cmd
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
python gradio_app.py
```

### Linux/macOS
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python gradio_app.py
```

## 🔧 模块化架构说明

### 项目结构
```
ModelScope-API-WebUI/
├── gradio_app.py              # 主应用文件（重构版）
├── modules/                   # 功能模块文件夹
│   ├── __init__.py           # 模块包初始化
│   ├── common.py             # 公共函数和工具
│   ├── text_to_image.py      # 文生图模块
│   ├── image_edit.py         # 图像编辑模块
│   ├── text_chat.py          # 文本对话模块
│   ├── image_to_text.py      # 图生文模块
│   ├── photopea.py           # Photopea编辑器模块
│   └── whiteboard.py         # 手绘白板模块
└── ...                       # 其他配置文件
```

### 模块说明
- **主文件**：`gradio_app.py` 负责界面组装和事件绑定
- **公共模块**：`modules/common.py` 包含API Token管理、配置加载等通用功能
- **功能模块**：每个功能独立成模块，便于维护和扩展
- **界面模块**：`modules/photopea.py` 提供Photopea编辑器的界面实现

### 开发优势
1. **代码清晰**：每个模块职责单一，代码组织清晰
2. **易于维护**：修改特定功能只需编辑对应模块
3. **便于扩展**：添加新功能只需创建新模块
4. **降低耦合**：模块间依赖关系明确，减少代码耦合

## 故障排除

### 常见问题
- **虚拟环境创建失败**：检查Python是否正确安装并添加到PATH
- **依赖安装失败**：检查网络连接，或尝试使用国内镜像源
- **程序启动失败**：检查gradio_app.py文件是否存在，以及相关配置文件是否正确
- **模块导入错误**：确保 `modules/` 文件夹及其内部文件完整存在

### 模块相关问题
- **功能异常**：检查对应模块文件是否完整
- **新功能不显示**：确认模块已正确导入到主文件中
- **API调用失败**：检查 `modules/common.py` 中的API配置

### 调试建议
1. **查看控制台输出**：启动时注意查看错误信息
2. **检查文件完整性**：确认所有模块文件都存在
3. **验证Python环境**：确保Python版本 >= 3.8
4. **网络连接**：确保能正常访问ModelScope API