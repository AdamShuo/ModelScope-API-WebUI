# ModelScope API WebUI å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†é¡¹ç›®çš„æ¨¡å—åŒ–æ¶æ„è®¾è®¡å’Œå¼€å‘è§„èŒƒï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£é¡¹ç›®ç»“æ„å¹¶è¿›è¡ŒåŠŸèƒ½æ‰©å±•ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### è®¾è®¡ç†å¿µ

é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†ä¸åŒåŠŸèƒ½åˆ†ç¦»åˆ°ç‹¬ç«‹çš„æ¨¡å—ä¸­ï¼Œå®ç°ï¼š
- **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªæ¨¡å—è´Ÿè´£å•ä¸€åŠŸèƒ½
- **ä½è€¦åˆ**ï¼šæ¨¡å—é—´ä¾èµ–å…³ç³»æ¸…æ™°
- **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€æ¨¡å—
- **æ˜“æ‰©å±•**ï¼šæ–°åŠŸèƒ½å¯ç‹¬ç«‹å¼€å‘å’Œé›†æˆ

### é¡¹ç›®ç»“æ„

```
ModelScope-API-WebUI/
â”œâ”€â”€ gradio_app.py              # ğŸ¯ ä¸»åº”ç”¨æ–‡ä»¶
â”œâ”€â”€ modules/                   # ğŸ“¦ åŠŸèƒ½æ¨¡å—åŒ…
â”‚   â”œâ”€â”€ __init__.py           # ğŸ“‹ æ¨¡å—åˆå§‹åŒ–
â”‚   â”œâ”€â”€ common.py             # ğŸ”§ å…¬å…±å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ text_to_image.py      # ğŸ¨ æ–‡ç”Ÿå›¾æ¨¡å—
â”‚   â”œâ”€â”€ image_edit.py         # âœï¸ å›¾åƒç¼–è¾‘æ¨¡å—
â”‚   â”œâ”€â”€ text_chat.py          # ğŸ’¬ æ–‡æœ¬å¯¹è¯æ¨¡å—
â”‚   â”œâ”€â”€ image_to_text.py      # ğŸ” å›¾ç”Ÿæ–‡æ¨¡å—
â”‚   â””â”€â”€ photopea.py           # ğŸ–¼ï¸ Photopeaç¼–è¾‘å™¨æ¨¡å—
â”œâ”€â”€ modelscope_config.json     # âš™ï¸ é…ç½®æ–‡ä»¶
â””â”€â”€ ...                       # å…¶ä»–æ–‡ä»¶
```

## ğŸ“¦ æ¨¡å—è¯¦è§£

### 1. ä¸»åº”ç”¨æ¨¡å— (`gradio_app.py`)

**èŒè´£**ï¼šç•Œé¢ç»„è£…ã€äº‹ä»¶ç»‘å®šã€åº”ç”¨å¯åŠ¨

**ä¸»è¦åŠŸèƒ½**ï¼š
- å¯¼å…¥å„åŠŸèƒ½æ¨¡å—
- åˆ›å»ºGradioç•Œé¢å¸ƒå±€
- ç»‘å®šç”¨æˆ·äº¤äº’äº‹ä»¶
- å¯åŠ¨Webåº”ç”¨

**ä»£ç ç»“æ„**ï¼š
```python
# å¯¼å…¥æ¨¡å—
from modules.common import load_config, load_api_token
from modules.text_to_image import generate_image
# ... å…¶ä»–å¯¼å…¥

# ç•Œé¢åˆ›å»ºå‡½æ•°
def create_text_to_image_tab(config, saved_token):
    # åˆ›å»ºæ ‡ç­¾é¡µç•Œé¢
    pass

def create_gradio_interface():
    # ç»„è£…å®Œæ•´ç•Œé¢
    pass

# åº”ç”¨å¯åŠ¨
if __name__ == "__main__":
    demo = create_gradio_interface()
    demo.launch(...)
```

### 2. å…¬å…±å·¥å…·æ¨¡å— (`modules/common.py`)

**èŒè´£**ï¼šæä¾›é€šç”¨åŠŸèƒ½å’Œå·¥å…·å‡½æ•°

**ä¸»è¦åŠŸèƒ½**ï¼š
- API Token åŠ å¯†å­˜å‚¨ç®¡ç†
- é…ç½®æ–‡ä»¶åŠ è½½
- å›¾åƒä¿¡æ¯è·å–
- APIè¯·æ±‚é‡è¯•æœºåˆ¶
- å›¾åƒå°ºå¯¸è®¡ç®—

**æ ¸å¿ƒå‡½æ•°**ï¼š
```python
def load_config()                    # åŠ è½½é…ç½®æ–‡ä»¶
def save_api_token(token)           # ä¿å­˜API Token
def load_api_token()                # åŠ è½½API Token
def make_api_request_with_retry()   # å¸¦é‡è¯•çš„APIè¯·æ±‚
def calculate_adaptive_size()       # è®¡ç®—è‡ªé€‚åº”å°ºå¯¸
def handle_token_save()             # Tokenä¿å­˜å¤„ç†
```

### 3. åŠŸèƒ½æ¨¡å—

#### æ–‡ç”Ÿå›¾æ¨¡å— (`modules/text_to_image.py`)
- **æ ¸å¿ƒå‡½æ•°**ï¼š`generate_image()`
- **åŠŸèƒ½**ï¼šæ–‡æœ¬æè¿°ç”Ÿæˆå›¾åƒ
- **APIè°ƒç”¨**ï¼šModelScope å›¾åƒç”ŸæˆAPI

#### å›¾åƒç¼–è¾‘æ¨¡å— (`modules/image_edit.py`)
- **æ ¸å¿ƒå‡½æ•°**ï¼š`edit_image()`
- **åŠŸèƒ½**ï¼šåŸºäºåŸå›¾çš„AIç¼–è¾‘
- **ç‰¹è‰²**ï¼šæ”¯æŒè‡ªé€‚åº”å°ºå¯¸ã€å›¾ç‰‡ä¸Šä¼ 

#### æ–‡æœ¬å¯¹è¯æ¨¡å— (`modules/text_chat.py`)
- **æ ¸å¿ƒå‡½æ•°**ï¼š`chat_with_model()`, `clear_chat()`
- **åŠŸèƒ½**ï¼šå¤šè½®å¯¹è¯ã€èŠå¤©å†å²ç®¡ç†
- **APIè°ƒç”¨**ï¼šOpenAIå…¼å®¹æ¥å£

#### å›¾ç”Ÿæ–‡æ¨¡å— (`modules/image_to_text.py`)
- **æ ¸å¿ƒå‡½æ•°**ï¼š`analyze_image_with_text()`
- **åŠŸèƒ½**ï¼šå›¾åƒåˆ†æã€è§†è§‰é—®ç­”
- **ç‰¹è‰²**ï¼šæ”¯æŒbase64å›¾åƒç¼–ç 

#### Photopeaæ¨¡å— (`modules/photopea.py`)
- **æ ¸å¿ƒå‡½æ•°**ï¼š`create_photopea_interface()`
- **åŠŸèƒ½**ï¼šåµŒå…¥åœ¨çº¿å›¾åƒç¼–è¾‘å™¨
- **ç‰¹è‰²**ï¼šiframeåµŒå…¥ã€ä¸“ä¸šç¼–è¾‘å·¥å…·

## ğŸ”§ å¼€å‘è§„èŒƒ

### æ¨¡å—å¼€å‘è§„èŒƒ

#### 1. æ–‡ä»¶å‘½å
- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- æ–‡ä»¶ååº”æè¿°æ¨¡å—åŠŸèƒ½
- ä¾‹ï¼š`text_to_image.py`, `image_edit.py`

#### 2. å‡½æ•°å‘½å
- ä½¿ç”¨åŠ¨è¯+åè¯çš„å½¢å¼
- æè¿°æ€§å¼ºï¼Œæ˜“äºç†è§£
- ä¾‹ï¼š`generate_image()`, `analyze_image_with_text()`

#### 3. æ¨¡å—ç»“æ„
```python
"""
æ¨¡å—è¯´æ˜æ–‡æ¡£
æè¿°æ¨¡å—çš„ä¸»è¦åŠŸèƒ½å’Œç”¨é€”
"""

# å¯¼å…¥ä¾èµ–
import gradio as gr
from .common import load_config

# æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
def main_function(param1, param2):
    """
    å‡½æ•°è¯´æ˜æ–‡æ¡£
    
    Args:
        param1: å‚æ•°1è¯´æ˜
        param2: å‚æ•°2è¯´æ˜
    
    Returns:
        è¿”å›å€¼è¯´æ˜
    """
    # å®ç°ä»£ç 
    pass

# ç•Œé¢åˆ›å»ºå‡½æ•°ï¼ˆå¦‚éœ€è¦ï¼‰
def create_interface():
    """åˆ›å»ºæ¨¡å—ç•Œé¢"""
    pass
```

#### 4. é”™è¯¯å¤„ç†
```python
def example_function():
    try:
        # ä¸»è¦é€»è¾‘
        result = api_call()
        return result, "æˆåŠŸä¿¡æ¯"
    except Exception as e:
        error_msg = f"æ“ä½œå¤±è´¥: {str(e)}"
        print(f"âŒ {error_msg}")
        return None, error_msg
```

### ç•Œé¢å¼€å‘è§„èŒƒ

#### 1. æ ‡ç­¾é¡µåˆ›å»º
```python
def create_feature_tab(config, saved_token):
    """åˆ›å»ºåŠŸèƒ½æ ‡ç­¾é¡µ"""
    with gr.Tab("åŠŸèƒ½åç§°"):
        with gr.Row():
            with gr.Column(scale=1):
                # è¾“å…¥æ§ä»¶
                input_component = gr.Textbox(...)
            
            with gr.Column(scale=1):
                # è¾“å‡ºæ§ä»¶
                output_component = gr.Image(...)
                button = gr.Button("æ‰§è¡Œ", variant="primary")
    
    return {
        'input': input_component,
        'output': output_component,
        'button': button
    }
```

#### 2. äº‹ä»¶ç»‘å®š
```python
# åœ¨ä¸»æ–‡ä»¶ä¸­ç»‘å®šäº‹ä»¶
components = create_feature_tab(config, saved_token)

components['button'].click(
    fn=feature_function,
    inputs=[components['input']],
    outputs=[components['output']]
)
```

## ğŸš€ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°åŠŸèƒ½æ¨¡å—

#### æ­¥éª¤1ï¼šåˆ›å»ºæ¨¡å—æ–‡ä»¶
åœ¨ `modules/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ `.py` æ–‡ä»¶ï¼š

```python
# modules/new_feature.py
"""
æ–°åŠŸèƒ½æ¨¡å—
å®ç°ç‰¹å®šçš„æ–°åŠŸèƒ½
"""

import gradio as gr
from .common import load_config

def new_feature_function(param1, param2):
    """æ–°åŠŸèƒ½çš„æ ¸å¿ƒå®ç°"""
    try:
        # åŠŸèƒ½å®ç°ä»£ç 
        result = process_data(param1, param2)
        return result, "å¤„ç†æˆåŠŸ"
    except Exception as e:
        return None, f"å¤„ç†å¤±è´¥: {str(e)}"

def create_new_feature_tab(config, saved_token):
    """åˆ›å»ºæ–°åŠŸèƒ½çš„ç•Œé¢"""
    with gr.Tab("æ–°åŠŸèƒ½"):
        with gr.Row():
            with gr.Column():
                input1 = gr.Textbox(label="è¾“å…¥1")
                input2 = gr.Textbox(label="è¾“å…¥2")
                button = gr.Button("æ‰§è¡Œ", variant="primary")
            
            with gr.Column():
                output = gr.Textbox(label="è¾“å‡ºç»“æœ")
    
    return {
        'input1': input1,
        'input2': input2,
        'output': output,
        'button': button
    }
```

#### æ­¥éª¤2ï¼šé›†æˆåˆ°ä¸»åº”ç”¨
åœ¨ `gradio_app.py` ä¸­å¯¼å…¥å’Œä½¿ç”¨ï¼š

```python
# æ·»åŠ å¯¼å…¥
from modules.new_feature import new_feature_function, create_new_feature_tab

def create_gradio_interface():
    # ... ç°æœ‰ä»£ç 
    
    # åˆ›å»ºæ–°åŠŸèƒ½æ ‡ç­¾é¡µ
    new_feature_components = create_new_feature_tab(config, saved_token)
    
    # ç»‘å®šäº‹ä»¶
    new_feature_components['button'].click(
        fn=new_feature_function,
        inputs=[
            new_feature_components['input1'],
            new_feature_components['input2']
        ],
        outputs=[new_feature_components['output']]
    )
```

### ä¿®æ”¹ç°æœ‰åŠŸèƒ½

#### 1. åŠŸèƒ½é€»è¾‘ä¿®æ”¹
ç›´æ¥ç¼–è¾‘å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ä¿®æ”¹æ–‡ç”Ÿå›¾åŠŸèƒ½ï¼š
- ç¼–è¾‘ `modules/text_to_image.py`
- ä¿®æ”¹ `generate_image()` å‡½æ•°

#### 2. ç•Œé¢ä¿®æ”¹
- ä¿®æ”¹ä¸»æ–‡ä»¶ä¸­çš„ç•Œé¢åˆ›å»ºå‡½æ•°
- æˆ–åœ¨æ¨¡å—ä¸­æ·»åŠ ç•Œé¢åˆ›å»ºå‡½æ•°

#### 3. é…ç½®ä¿®æ”¹
- ç¼–è¾‘ `modelscope_config.json` æ·»åŠ æ–°é…ç½®
- åœ¨ `modules/common.py` ä¸­æ·»åŠ é…ç½®åŠ è½½é€»è¾‘

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### æœ¬åœ°æµ‹è¯•
```bash
# å¯åŠ¨åº”ç”¨
python gradio_app.py

# æˆ–ä½¿ç”¨è„šæœ¬
./run_windows.bat  # Windows
./run_linux.sh     # Linux/macOS
```

### è°ƒè¯•æŠ€å·§

#### 1. æ§åˆ¶å°è¾“å‡º
```python
print(f"ğŸ” è°ƒè¯•ä¿¡æ¯: {variable}")
print(f"âœ… æˆåŠŸ: {success_message}")
print(f"âŒ é”™è¯¯: {error_message}")
```

#### 2. å¼‚å¸¸å¤„ç†
```python
try:
    result = risky_operation()
except Exception as e:
    print(f"âŒ å¼‚å¸¸è¯¦æƒ…: {type(e).__name__}: {str(e)}")
    import traceback
    traceback.print_exc()
```

#### 3. å‚æ•°éªŒè¯
```python
def validate_inputs(param1, param2):
    """éªŒè¯è¾“å…¥å‚æ•°"""
    if not param1:
        return False, "å‚æ•°1ä¸èƒ½ä¸ºç©º"
    if not isinstance(param2, str):
        return False, "å‚æ•°2å¿…é¡»æ˜¯å­—ç¬¦ä¸²"
    return True, "éªŒè¯é€šè¿‡"
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. ä»£ç ç»„ç»‡
- ä¿æŒæ¨¡å—èŒè´£å•ä¸€
- é¿å…å¾ªç¯å¯¼å…¥
- ä½¿ç”¨ç›¸å¯¹å¯¼å…¥å¼•ç”¨æ¨¡å—å†…éƒ¨ä¾èµ–

### 2. é”™è¯¯å¤„ç†
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- è®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- ä¼˜é›…åœ°å¤„ç†APIè°ƒç”¨å¤±è´¥

### 3. æ€§èƒ½ä¼˜åŒ–
- é¿å…é‡å¤çš„APIè°ƒç”¨
- åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- ä¼˜åŒ–å›¾åƒå¤„ç†æµç¨‹

### 4. ç”¨æˆ·ä½“éªŒ
- æä¾›æ¸…æ™°çš„æ“ä½œæç¤º
- æ˜¾ç¤ºå¤„ç†è¿›åº¦ä¿¡æ¯
- æ”¯æŒæ“ä½œæ’¤é”€å’Œé‡è¯•

## ğŸ”„ ç‰ˆæœ¬ç®¡ç†

### Git å·¥ä½œæµ
```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/new-module

# å¼€å‘å®Œæˆåæäº¤
git add modules/new_feature.py
git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½æ¨¡å—"

# åˆå¹¶åˆ°ä¸»åˆ†æ”¯
git checkout main
git merge feature/new-module
```

### ç‰ˆæœ¬å‘å¸ƒ
1. æ›´æ–°ç‰ˆæœ¬å·
2. æ›´æ–°æ–‡æ¡£
3. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
4. åˆ›å»ºå‘å¸ƒæ ‡ç­¾

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ–‡æ¡£**ï¼šé¦–å…ˆæŸ¥é˜…æœ¬å¼€å‘æŒ‡å—å’ŒREADME
2. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
3. **è°ƒè¯•ä»£ç **ï¼šä½¿ç”¨printè¯­å¥æˆ–è°ƒè¯•å™¨å®šä½é—®é¢˜
4. **æäº¤Issue**ï¼šåœ¨GitHubä¸Šæäº¤è¯¦ç»†çš„é—®é¢˜æŠ¥å‘Š

---

å¸Œæœ›è¿™ä»½å¼€å‘æŒ‡å—èƒ½å¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£å’Œæ‰©å±• ModelScope API WebUI é¡¹ç›®ï¼