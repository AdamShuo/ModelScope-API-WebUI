# ModelScope API WebUI 开发指南

本文档详细介绍了项目的模块化架构设计和开发规范，帮助开发者理解项目结构并进行功能扩展。

## 🏗️ 架构概览

### 设计理念

项目采用模块化设计，将不同功能分离到独立的模块中，实现：
- **职责分离**：每个模块负责单一功能
- **低耦合**：模块间依赖关系清晰
- **高内聚**：相关功能集中在同一模块
- **易扩展**：新功能可独立开发和集成

### 项目结构

```
ModelScope-API-WebUI/
├── gradio_app.py              # 🎯 主应用文件
├── modules/                   # 📦 功能模块包
│   ├── __init__.py           # 📋 模块初始化
│   ├── common.py             # 🔧 公共工具模块
│   ├── text_to_image.py      # 🎨 文生图模块
│   ├── image_edit.py         # ✏️ 图像编辑模块
│   ├── text_chat.py          # 💬 文本对话模块
│   ├── image_to_text.py      # 🔍 图生文模块
│   └── photopea.py           # 🖼️ Photopea编辑器模块
├── modelscope_config.json     # ⚙️ 配置文件
└── ...                       # 其他文件
```

## 📦 模块详解

### 1. 主应用模块 (`gradio_app.py`)

**职责**：界面组装、事件绑定、应用启动

**主要功能**：
- 导入各功能模块
- 创建Gradio界面布局
- 绑定用户交互事件
- 启动Web应用

**代码结构**：
```python
# 导入模块
from modules.common import load_config, load_api_token
from modules.text_to_image import generate_image
# ... 其他导入

# 界面创建函数
def create_text_to_image_tab(config, saved_token):
    # 创建标签页界面
    pass

def create_gradio_interface():
    # 组装完整界面
    pass

# 应用启动
if __name__ == "__main__":
    demo = create_gradio_interface()
    demo.launch(...)
```

### 2. 公共工具模块 (`modules/common.py`)

**职责**：提供通用功能和工具函数

**主要功能**：
- API Token 加密存储管理
- 配置文件加载
- 图像信息获取
- API请求重试机制
- 图像尺寸计算

**核心函数**：
```python
def load_config()                    # 加载配置文件
def save_api_token(token)           # 保存API Token
def load_api_token()                # 加载API Token
def make_api_request_with_retry()   # 带重试的API请求
def calculate_adaptive_size()       # 计算自适应尺寸
def handle_token_save()             # Token保存处理
```

### 3. 功能模块

#### 文生图模块 (`modules/text_to_image.py`)
- **核心函数**：`generate_image()`
- **功能**：文本描述生成图像
- **API调用**：ModelScope 图像生成API

#### 图像编辑模块 (`modules/image_edit.py`)
- **核心函数**：`edit_image()`
- **功能**：基于原图的AI编辑
- **特色**：支持自适应尺寸、图片上传

#### 文本对话模块 (`modules/text_chat.py`)
- **核心函数**：`chat_with_model()`, `clear_chat()`
- **功能**：多轮对话、聊天历史管理
- **API调用**：OpenAI兼容接口

#### 图生文模块 (`modules/image_to_text.py`)
- **核心函数**：`analyze_image_with_text()`
- **功能**：图像分析、视觉问答
- **特色**：支持base64图像编码

#### Photopea模块 (`modules/photopea.py`)
- **核心函数**：`create_photopea_interface()`
- **功能**：嵌入在线图像编辑器
- **特色**：iframe嵌入、专业编辑工具

## 🔧 开发规范

### 模块开发规范

#### 1. 文件命名
- 使用小写字母和下划线
- 文件名应描述模块功能
- 例：`text_to_image.py`, `image_edit.py`

#### 2. 函数命名
- 使用动词+名词的形式
- 描述性强，易于理解
- 例：`generate_image()`, `analyze_image_with_text()`

#### 3. 模块结构
```python
"""
模块说明文档
描述模块的主要功能和用途
"""

# 导入依赖
import gradio as gr
from .common import load_config

# 核心功能函数
def main_function(param1, param2):
    """
    函数说明文档
    
    Args:
        param1: 参数1说明
        param2: 参数2说明
    
    Returns:
        返回值说明
    """
    # 实现代码
    pass

# 界面创建函数（如需要）
def create_interface():
    """创建模块界面"""
    pass
```

#### 4. 错误处理
```python
def example_function():
    try:
        # 主要逻辑
        result = api_call()
        return result, "成功信息"
    except Exception as e:
        error_msg = f"操作失败: {str(e)}"
        print(f"❌ {error_msg}")
        return None, error_msg
```

### 界面开发规范

#### 1. 标签页创建
```python
def create_feature_tab(config, saved_token):
    """创建功能标签页"""
    with gr.Tab("功能名称"):
        with gr.Row():
            with gr.Column(scale=1):
                # 输入控件
                input_component = gr.Textbox(...)
            
            with gr.Column(scale=1):
                # 输出控件
                output_component = gr.Image(...)
                button = gr.Button("执行", variant="primary")
    
    return {
        'input': input_component,
        'output': output_component,
        'button': button
    }
```

#### 2. 事件绑定
```python
# 在主文件中绑定事件
components = create_feature_tab(config, saved_token)

components['button'].click(
    fn=feature_function,
    inputs=[components['input']],
    outputs=[components['output']]
)
```

## 🚀 扩展开发

### 添加新功能模块

#### 步骤1：创建模块文件
在 `modules/` 目录下创建新的 `.py` 文件：

```python
# modules/new_feature.py
"""
新功能模块
实现特定的新功能
"""

import gradio as gr
from .common import load_config

def new_feature_function(param1, param2):
    """新功能的核心实现"""
    try:
        # 功能实现代码
        result = process_data(param1, param2)
        return result, "处理成功"
    except Exception as e:
        return None, f"处理失败: {str(e)}"

def create_new_feature_tab(config, saved_token):
    """创建新功能的界面"""
    with gr.Tab("新功能"):
        with gr.Row():
            with gr.Column():
                input1 = gr.Textbox(label="输入1")
                input2 = gr.Textbox(label="输入2")
                button = gr.Button("执行", variant="primary")
            
            with gr.Column():
                output = gr.Textbox(label="输出结果")
    
    return {
        'input1': input1,
        'input2': input2,
        'output': output,
        'button': button
    }
```

#### 步骤2：集成到主应用
在 `gradio_app.py` 中导入和使用：

```python
# 添加导入
from modules.new_feature import new_feature_function, create_new_feature_tab

def create_gradio_interface():
    # ... 现有代码
    
    # 创建新功能标签页
    new_feature_components = create_new_feature_tab(config, saved_token)
    
    # 绑定事件
    new_feature_components['button'].click(
        fn=new_feature_function,
        inputs=[
            new_feature_components['input1'],
            new_feature_components['input2']
        ],
        outputs=[new_feature_components['output']]
    )
```

### 修改现有功能

#### 1. 功能逻辑修改
直接编辑对应的模块文件，如修改文生图功能：
- 编辑 `modules/text_to_image.py`
- 修改 `generate_image()` 函数

#### 2. 界面修改
- 修改主文件中的界面创建函数
- 或在模块中添加界面创建函数

#### 3. 配置修改
- 编辑 `modelscope_config.json` 添加新配置
- 在 `modules/common.py` 中添加配置加载逻辑

## 🧪 测试和调试

### 本地测试
```bash
# 启动应用
python gradio_app.py

# 或使用脚本
./run_windows.bat  # Windows
./run_linux.sh     # Linux/macOS
```

### 调试技巧

#### 1. 控制台输出
```python
print(f"🔍 调试信息: {variable}")
print(f"✅ 成功: {success_message}")
print(f"❌ 错误: {error_message}")
```

#### 2. 异常处理
```python
try:
    result = risky_operation()
except Exception as e:
    print(f"❌ 异常详情: {type(e).__name__}: {str(e)}")
    import traceback
    traceback.print_exc()
```

#### 3. 参数验证
```python
def validate_inputs(param1, param2):
    """验证输入参数"""
    if not param1:
        return False, "参数1不能为空"
    if not isinstance(param2, str):
        return False, "参数2必须是字符串"
    return True, "验证通过"
```

## 📚 最佳实践

### 1. 代码组织
- 保持模块职责单一
- 避免循环导入
- 使用相对导入引用模块内部依赖

### 2. 错误处理
- 提供用户友好的错误信息
- 记录详细的调试信息
- 优雅地处理API调用失败

### 3. 性能优化
- 避免重复的API调用
- 合理使用缓存机制
- 优化图像处理流程

### 4. 用户体验
- 提供清晰的操作提示
- 显示处理进度信息
- 支持操作撤销和重试

## 🔄 版本管理

### Git 工作流
```bash
# 创建功能分支
git checkout -b feature/new-module

# 开发完成后提交
git add modules/new_feature.py
git commit -m "feat: 添加新功能模块"

# 合并到主分支
git checkout main
git merge feature/new-module
```

### 版本发布
1. 更新版本号
2. 更新文档
3. 测试所有功能
4. 创建发布标签

## 📞 技术支持

如果在开发过程中遇到问题：

1. **查看文档**：首先查阅本开发指南和README
2. **检查日志**：查看控制台输出的错误信息
3. **调试代码**：使用print语句或调试器定位问题
4. **提交Issue**：在GitHub上提交详细的问题报告

---

希望这份开发指南能帮助您更好地理解和扩展 ModelScope API WebUI 项目！