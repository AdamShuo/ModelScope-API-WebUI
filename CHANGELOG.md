# ModelScope API WebUI 变更日志

## [最新版本] - 2025-10-01

### ✨ 新增功能

#### 1. 元数据嵌入功能
- **文生图模块**：生成的图像自动包含除API token外的所有生成参数
- **图像编辑模块**：编辑后的图像自动包含编辑参数和原图信息
- **元数据格式**：使用EXIF MakerNote标签(0x927C)存储JSON格式参数
- **可选开关**：每个模块都有"包含生成参数"勾选项，用户可控制是否启用

#### 2. 参数管理功能
- **保存参数**：可将当前生成参数保存为JSON文件，自动命名格式为`t2i_YYYYMMDD_HHMMSS.json`或`i2i_YYYYMMDD_HHMMSS.json`
- **加载参数**：支持上传包含元数据的图片或JSON文件，自动填充参数
- **标准对话框**：使用Windows标准文件选择器界面
- **临时文件处理**：安全的临时文件创建和清理机制

#### 3. 界面优化
- **布局调整**：参数管理控件移至输出区域中间，平衡界面布局
- **用户体验**：更直观的参数保存和加载流程
- **响应式设计**：保持界面美观和功能平衡

### 🔧 技术改进

#### 1. 元数据技术实现
- **EXIF标准**：遵循EXIF 2.3标准，使用MakerNote自定义标签
- **PIL集成**：使用Pillow库进行图像元数据操作
- **JSON序列化**：参数序列化为JSON格式存储
- **错误处理**：完善的元数据读写异常处理

#### 2. 参数管理实现
- **文件操作**：安全的文件读写和临时文件管理
- **JSON解析**：完整的参数解析和验证机制
- **界面集成**：与Gradio框架深度集成
- **跨平台支持**：兼容Windows、Linux、macOS的文件操作

#### 3. 批处理优化
- **虚拟环境检查**：改进的虚拟环境存在性检测
- **依赖管理**：优化的依赖安装逻辑
- **错误处理**：更完善的错误处理和用户提示

### 🐛 问题修复

#### 1. 元数据相关修复
- **参数加载错误**：修复加载本应用生成的图片时参数获取不正确的问题
- **格式兼容性**：修复上传对话框对webp格式的支持
- **标签查找**：正确查找MakerNote标签而非UserComment标签

#### 2. 参数管理修复
- **文件保存路径**：修复保存参数时的路径权限问题
- **下载对话框**：改进文件保存的用户体验
- **参数验证**：增强参数加载的验证逻辑

#### 3. 批处理修复
- **重复创建环境**：修复run_windows.bat总是重新创建虚拟环境的问题
- **依赖检查**：改进依赖包的安装和检查逻辑
- **启动优化**：更快的应用启动速度

### 📦 依赖更新

#### 新增依赖
- **Pillow**：图像处理和元数据操作（已存在，功能增强）
- **json**：参数序列化和反序列化（Python标准库）

#### 版本要求
- **Pillow** >= 10.0.0（支持完整的EXIF操作）
- **Python** >= 3.8（确保所有功能兼容性）

### 🔒 安全改进

#### 1. 文件安全
- **临时文件清理**：自动清理生成的临时文件
- **路径限制**：限制文件操作路径，防止目录遍历攻击
- **权限控制**：确保文件操作在安全权限范围内

#### 2. 数据安全
- **API Token保护**：继续使用加密存储机制
- **参数验证**：所有加载的参数都经过严格验证
- **错误处理**：完善的异常处理，防止信息泄露

### 🎯 使用指南

#### 元数据功能使用
1. **启用元数据**：在文生图或图像编辑模块勾选"包含生成参数"
2. **查看元数据**：使用图像查看器或专业工具查看EXIF信息
3. **参数复用**：加载包含元数据的图片可自动填充参数

#### 参数管理使用
1. **保存参数**：点击"保存参数"按钮，选择保存位置
2. **加载参数**：点击"加载参数"，选择图片或JSON文件
3. **批量处理**：保存的参数文件可用于批量生成相似风格的图像

### 📋 兼容性说明

#### 支持的文件格式
- **图像格式**：JPEG、PNG、WEBP（支持元数据）
- **参数文件**：JSON格式，UTF-8编码
- **元数据标准**：EXIF 2.3及以上

#### 系统要求
- **操作系统**：Windows 10/11、Linux、macOS
- **Python版本**：3.8及以上
- **内存要求**：至少4GB可用内存

### 🔮 未来计划

#### 短期计划
- [ ] 批量参数处理功能
- [ ] 参数模板管理
- [ ] 元数据可视化界面

#### 长期计划
- [ ] 云端参数同步
- [ ] 参数分享社区
- [ ] AI参数优化建议

---

**注意**：本变更日志记录了所有重要的功能变更、技术改进和问题修复。建议用户定期查看以了解最新功能和使用方法。